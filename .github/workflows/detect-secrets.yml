name: Pre-Commit Secret Detection

on:
  push:
    branches: [ main, dev, staging ]
  pull_request:
    branches: [ main ]

jobs:
  detect-secrets:
    uses: ./.github/workflows/reusable-secret-scan.yml
    with:
      scan-depth: '0'
      fail-on-error: true

  custom-patterns:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for specific secrets
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç Scanning for known secret patterns..."

          SEARCH_PATHS=(
            ".configs"
            "mai-advisor-mcp/.configs"
          )

          # Filter to directories that actually exist
          FILTERED_PATHS=()
          for dir in "${SEARCH_PATHS[@]}"; do
            if [[ -d "$dir" ]]; then
              FILTERED_PATHS+=("$dir")
            fi
          done

          if [[ ${#FILTERED_PATHS[@]} -eq 0 ]]; then
            echo "::notice::No .configs directories found to scan."
            exit 0
          fi

          PATTERNS=(
            "BSA[a-zA-Z0-9]{27}"
            "tvly-[a-zA-Z0-9-]{30,}"
            "/Volumes/1tb-sandisk/"
            "BRAVE_API_KEY.*[\"'][^\"']{10,}[\"']"
            "tavilyApiKey=[^&\"\\s]{10,}"
          )

          FOUND=0

          for pattern in "${PATTERNS[@]}"; do
            for dir in "${FILTERED_PATHS[@]}"; do
              if grep -rE "$pattern" "$dir" 2>/dev/null; then
                echo "‚ùå Found pattern: $pattern in $dir"
                FOUND=1
              fi
            done
          done

          if [[ $FOUND -eq 1 ]]; then
            echo ""
            echo "‚ö†Ô∏è SECRETS DETECTED! Please run './sanitize-settings.sh' locally to scrub configs before pushing."
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi

      - name: Comment on PR if secrets found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
                body: 'üö® **Secrets Detected in PR**\n\n' +
                  'This PR contains API keys or sensitive paths within `.configs/`.\n\n' +
                  '**Please:**\n' +
                  '1. Run `./sanitize-settings.sh` locally (or `python3 .github/scripts/sanitize.py <file>`).\n' +
                  '2. Review and commit the sanitized files.\n' +
                  '3. Push to update this PR.\n\n' +
                  '**Use the template if needed:**\n' +
                  '`.configs/MCP/settings.json.template`'
            })
