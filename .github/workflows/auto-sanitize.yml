name: Auto-Sanitize Secrets

on:
  push:
    branches: [ main, dev, staging ]
    paths:
      - 'mai-advisor-mcp/.configs/**/*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'mai-advisor-mcp/.configs/**/*.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  sanitize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Sanitize settings.json files
        run: |
          echo "üßπ Sanitizing settings.json files..."
          
          # Find and process all settings.json files
          find mai-advisor-mcp/.configs -name "settings.json" -type f | while read -r file; do
            echo "Processing: $file"
            
            # Sanitize using jq
            jq 'walk(
              if type == "object" then
                # Remove API keys
                if has("BRAVE_API_KEY") then .BRAVE_API_KEY = "YOUR_BRAVE_API_KEY_HERE" else . end |
                if has("TAVILY_API_KEY") then .TAVILY_API_KEY = "YOUR_TAVILY_API_KEY_HERE" else . end |
                # Replace absolute paths with placeholders
                if has("cwd") and (.cwd | startswith("/Volumes/") or startswith("/Users/")) then 
                  .cwd = "/path/to/your/mcp/servers" 
                else . end |
                if has("MEMORY_FILE_PATH") and (.MEMORY_FILE_PATH | startswith("/Volumes/") or startswith("/Users/")) then 
                  .MEMORY_FILE_PATH = "/path/to/your/memory/memories.jsonl" 
                else . end
              else . end
            ) | walk(
              if type == "array" then
                map(if type == "string" and contains("tavilyApiKey=") then
                  sub("tavilyApiKey=[^&\"\\s]+"; "tavilyApiKey=YOUR_TAVILY_API_KEY_HERE")
                else . end)
              else . end
            ) | walk(
              if type == "string" then
                # Replace any remaining API key patterns
                gsub("BSA[a-zA-Z0-9]{27}"; "YOUR_BRAVE_API_KEY_HERE") |
                gsub("tvly-[a-zA-Z0-9-]{30,}"; "YOUR_TAVILY_API_KEY_HERE")
              else . end
            )' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            
            echo "‚úì Sanitized: $file"
          done

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet mai-advisor-mcp/.configs/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No secrets found to sanitize"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Secrets were found and sanitized!"
          fi

      - name: Commit sanitized files
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add mai-advisor-mcp/.configs/
          git commit -m "üîí chore: auto-sanitize secrets from settings.json files [skip ci]"

      - name: Push changes
        if: steps.check_changes.outputs.changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Notify on PR
        if: steps.check_changes.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Secrets Detected and Sanitized**\n\nAPI keys and local paths were automatically removed from your settings.json files.\n\n**What was cleaned:**\n- API keys (Brave, Tavily)\n- Local file paths\n- Sensitive configuration values\n\nPlease review the changes and update your local configuration files accordingly.'
            })
