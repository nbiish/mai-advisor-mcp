name: Reusable Secret Scan

on:
  workflow_call:
    inputs:
      scan-depth:
        description: 'Depth of commit history to scan'
        required: false
        type: string
        default: '0'
      fail-on-error:
        description: 'Whether to fail the workflow if secrets are found'
        required: false
        type: boolean
        default: true

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ inputs.scan-depth }}

      - name: Determine diff range for TruffleHog
        id: diff-range
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          ZERO_SHA="0000000000000000000000000000000000000000"

          BASE=""
          HEAD="${{ github.sha }}"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          elif [[ -n "${{ github.event.before }}" && "${{ github.event.before }}" != "$ZERO_SHA" ]]; then
            BASE="${{ github.event.before }}"
          else
            git fetch origin "$DEFAULT_BRANCH" --depth=1
            BASE="origin/$DEFAULT_BRANCH"
          fi

          if [[ "$BASE" == "$HEAD" ]]; then
            echo "Base and head identical; falling back to parent commit or default branch"
            if git rev-parse "${HEAD}^" >/dev/null 2>&1; then
              BASE="$(git rev-parse "${HEAD}^")"
            else
              git fetch origin "$DEFAULT_BRANCH" --depth=2
              BASE="origin/$DEFAULT_BRANCH"
            fi
          fi

          echo "base=$BASE" >> "$GITHUB_OUTPUT"
          echo "head=$HEAD" >> "$GITHUB_OUTPUT"
          echo "Resolved diff range: base=$BASE head=$HEAD"

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.diff-range.outputs.base }}
          head: ${{ steps.diff-range.outputs.head }}
          extra_args: --debug --only-verified

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
