name: PQC Readiness Audit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 1' # Weekly scan on Monday

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cbom_scan:
    name: Generate Cryptographic Bill of Materials
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # Required for uploading SARIF

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate CBOM
        uses: cbomkit/cbomkit-action@v2.1.2
        with:
          output-format: json
          output-file: cbom.json
          # scan-target: '.' # Default is root

      - name: Upload CBOM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: crypto-inventory
          path: cbom.json

      - name: Enforce PQC Hybrid Standards
        continue-on-error: true # Soft fail for now
        run: |
          echo "ðŸ” Analyzing Cryptographic Bill of Materials (CBOM)..."
          
          # Check if CBOM exists
          if [ ! -f cbom.json ]; then
            echo "::error::CBOM file not found!"
            exit 1
          fi

          # Install jq for robust parsing
          sudo apt-get update && sudo apt-get install -y jq

          # Check if CBOM is empty or has no components (no crypto found)
          if [ ! -s cbom.json ] || [ "$(jq '.components | length' cbom.json)" -eq 0 ]; then
             echo "::notice title=No Crypto Detected::No cryptographic assets found in this repository. Skipping PQC checks."
             exit 0
          fi

          # 1. Check for Legacy RSA (Classical)
          # Using jq to find RSA occurrences
          if jq -e '.. | objects | select(.algorithm == "RSA")' cbom.json > /dev/null; then
             echo "::warning title=Legacy Crypto Detected::RSA algorithm detected. Ensure this is used in Hybrid Mode with ML-KEM."
             # Optional: Fail if key length is small
             if jq -e '.. | objects | select(.algorithm == "RSA" and .keyLength < 2048)' cbom.json > /dev/null; then
                echo "::error title=Weak Crypto::RSA key length < 2048 detected!"
             fi
          fi

          # 2. Check for Legacy ECC (Classical)
          if jq -e '.. | objects | select(.algorithm | test("EC|Elliptic Curve"))' cbom.json > /dev/null; then
            echo "::warning title=Legacy Crypto Detected::Elliptic Curve detected. Ensure this is used in Hybrid Mode with ML-DSA."
          fi

          # 3. Check for Post-Quantum Algorithms (The Goal)
          if jq -e '.. | objects | select(.algorithm | test("ML-KEM|Kyber"))' cbom.json > /dev/null; then
            echo "âœ… PQC Key Encapsulation (ML-KEM/Kyber) detected."
          else
            echo "::notice title=PQC Gap::No Post-Quantum Key Encapsulation (ML-KEM) found."
          fi

          if jq -e '.. | objects | select(.algorithm | test("ML-DSA|Dilithium"))' cbom.json > /dev/null; then
            echo "âœ… PQC Digital Signatures (ML-DSA/Dilithium) detected."
          else
            echo "::notice title=PQC Gap::No Post-Quantum Digital Signatures (ML-DSA) found."
          fi


